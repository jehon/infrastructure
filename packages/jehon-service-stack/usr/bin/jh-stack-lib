#!/usr/bin/env bash

set -o errexit

# shellcheck source-path=SCRIPTDIR/../../../jehon/usr/bin
. jh-lib

#
#
# Helpers
#
#

stackRoot=/opt/jehon/stack
export stackRoot
PATH="$stackRoot/bin:$PATH"
export PATH

jh_stack_update() {
    header_begin "Create .env"
    cat >"${stackRoot}"/.env <<EOS
# User running the stack
# id: $(id)
PUID=$(id -u)
PGID=$(id -g)
TZ=$(cat /etc/timezone)
EOS
    header_end

    header_begin "Getting new images"
    docker compose pull \
        --quiet
    header_end

    header_begin "Building new images"
    docker compose build
    header_end

    header_begin "Restart with new images"
    docker compose up \
        --remove-orphans \
        --detach --wait
    header_end
}

jh_stack_rc() {
    # --links: transform symlinks
    rclone \
        --verbose \
        --skip-links --one-file-system \
        --config /etc/jehon/rclone.conf \
        "$@"
}

FORCE=""
if [ "$1" == "-f" ]; then
    echo "Forcing run"
    FORCE="force"
    jh_exclusive_kill
fi

if ! jh_exclusive; then
    echo "Already running"
    exit 0
fi
export FORCE
