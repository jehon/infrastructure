#!/usr/bin/env bash

set -o errexit

# shellcheck source-path=SCRIPTDIR/../../../jehon/usr/bin
. jh-lib

#
#
# Helpers
#
#

stackRoot=/home/jehon-daemon/stack
export stackRoot

update_stack() {
    header_begin "Create .env"
    cat >"${stackRoot}"/.env <<EOS
# User running the stack
# id: $(id)
PUID=$(id -u)
PGID=$(id -g)
TZ=$(cat /etc/timezone)
EOS
    header_end

    header_begin "Getting new images"
    docker compose pull \
        --quiet
    header_end

    header_begin "Building new images"
    docker compose build
    header_end

    header_begin "Restart with new images"
    docker compose up \
        --remove-orphans \
        --detach --wait
    header_end
}
