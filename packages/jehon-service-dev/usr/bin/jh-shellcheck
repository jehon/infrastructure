#!/usr/bin/env bash

set -o errexit

# shellcheck source-path=SCRIPTDIR/../../../jehon/usr/bin/
. jh-lib

exclude="ðŸ”’"
res=
fix=

if [ "$1" == "fix" ]; then
	fix="yes"
	shift
fi

checkOne() {
	file="$1"

	if [ "$fix" == "yes" ]; then
		shfmt -w "$file"
		shellcheck -f diff "$file" | git apply --allow-empty
	fi

	if ! shellcheck --external-sources "$file" >&/dev/null; then
		echo "[shellcheck] $file"
		res="error"
	fi

	check="$(shfmt -l "$file")"
	if [ -n "$check" ]; then
		echo "[shfmt] $file"
		res="error"
	fi
}

if [ -n "$1" ]; then
	checkOne "$1"
else
	while read -r f; do
		checkOne "$f"
	done < <(
		git ls-files |
			grep --invert-match --extended-regex "$exclude" |
			xargs --no-run-if-empty file --mime-type -f - |
			(grep "x-shellscript" || true) |
			cut --delimiter : --field 1
	)
fi

if [ -n "$res" ]; then
	jh_fatal "Shellcheck failed"
fi

ok "Shellcheck passed"
