#!/usr/bin/env bash

set -o errexit

# shellcheck source-path=SCRIPTDIR/../../../jehon/usr/bin/
. jh-lib

exclude="${1:-"ðŸ”’"}"
res=0

checkOne() {
	file="$1"
	if ! shellcheck --external-sources "$file" >&/dev/null; then
		echo "[shellcheck] $file"
		res=1
	fi
}

if [ -n "$1" ]; then
	checkOne "$1"
else
	while read -r f; do
		checkOne "$f"
	done < <(
		git ls-files |
			grep --invert-match --extended-regex "$exclude" |
			xargs --no-run-if-empty file --mime-type -f - |
			(grep "x-shellscript" || true) |
			cut --delimiter : --field 1
	)
fi

if [ "$res" -ne 0 ]; then
	jh_fatal "Shellcheck failed"
fi

ok
