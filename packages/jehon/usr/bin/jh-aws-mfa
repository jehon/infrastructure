#!/usr/bin/env bash

#
# We can not source jh-lib
# on script that are integrated in the shell
#

AWS_PROFILE="${AWS_PROFILE:=default}"
awsMfaCache=~/restricted/tmp-aws-mfa

if [ -r "$awsMfaCache" ]; then
    echo "Trying $awsMfaCache..."

    # shellcheck source=/dev/null
    . "$awsMfaCache"

    if jh-aws-authenticated; then
        echo "Using $awsMfaCache"
        return
    fi
    echo "Cache in $awsMfaCache is too old"
fi

AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_SESSION_TOKEN=
JH_AWS_MFA_UNTIL=

echo "* Fetching MFA devices..."
mfa_devices=$(aws iam list-mfa-devices --profile "$AWS_PROFILE" --output json)
mfa_arn=$(echo "$mfa_devices" | jq -r '.MFADevices | map(select(.SerialNumber | test("^arn:aws:iam::[0-9]+:mfa/"))) | .[0].SerialNumber')

if [ -z "$mfa_arn" ]; then
    echo "Could not get MFA devices"
else
    echo "* Authenticating with $mfa_arn"
    echo -n "Token: "
    read -r aws_token
    json="$(aws sts get-session-token --serial-number "$mfa_arn" --token-code "$aws_token" --profile "$AWS_PROFILE" --output json)"
    if [ -z "$json" ]; then
        echo "Could not get MFA token"
    else
        AWS_ACCESS_KEY_ID="$(echo "$json" | jq -r ".Credentials.AccessKeyId")"
        AWS_SECRET_ACCESS_KEY="$(echo "$json" | jq -r ".Credentials.SecretAccessKey")"
        AWS_SESSION_TOKEN="$(echo "$json" | jq -r ".Credentials.SessionToken")"
        JH_AWS_MFA_UNTIL="$(date "+%F-%T" -d "12 hours")"

        export AWS_ACCESS_KEY_ID
        export AWS_SECRET_ACCESS_KEY
        export AWS_SESSION_TOKEN
        export JH_AWS_MFA_UNTIL

        # echo "* Detected config"
        # echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID"
        # echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY"
        # echo "AWS_SESSION_TOKEN=$AWS_SESSION_TOKEN"

        echo "* Valid untill $JH_AWS_MFA_UNTIL"

        echo "* Check caller identity"
        aws sts get-caller-identity --no-cli-pager

        (
            echo "#"
            echo "# Generated by jh-aws-mfa on $(date)"
            echo "#"
            echo ""
            echo "export AWS_ACCESS_KEY_ID='$AWS_ACCESS_KEY_ID'"
            echo "export AWS_SECRET_ACCESS_KEY='$AWS_SECRET_ACCESS_KEY'"
            echo "export AWS_SESSION_TOKEN='$AWS_SESSION_TOKEN'"
            echo "export JH_AWS_MFA_UNTIL='$JH_AWS_MFA_UNTIL'"
        ) >"$awsMfaCache"

    fi
fi
