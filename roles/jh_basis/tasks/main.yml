---
- name: Install packages
  when: ansible_pkg_mgr == "apt"
  block:
    - name: Install jehon.deb
      block:
        # We need this one to be installed first, because next line will depend on it
        - name: "Install jehon.deb from the web"
          ansible.builtin.apt:
            deb: "https://jehon.github.io/packages/jehon.deb"
          notify: jh_basis.indexes
          register: jehon_basis_jehon_deb
          # Example: [run]   msg: Breaks existing package 'jehon-hardware-wsl' dependency jehon (<= 2023.06.28.14.53.03)
          failed_when: >
            jehon_basis_jehon_deb.failed
            and (
              ('A later version is already installed' != jehon_basis_jehon_deb.msg)
              and (' dependency jehon (' not in jehon_basis_jehon_deb.msg)
            )

        - name: Refresh indexes for jehon
          ansible.builtin.meta: flush_handlers

    - name: Install jehon-hardware*.deb
      when: jehon_hardware | length > 0
      block:
        - name: "Ensure jehon-hardware is present for hardware {{ jehon_hardware }}"
          ansible.builtin.apt:
            pkg:
              - "jehon-hardware-{{ jehon_hardware }}"

    - name: "Ensure jehon-service-headless is present"
      when: jehon_headless
      ansible.builtin.apt:
        pkg:
          - "jehon-service-headless"

    - name: Add jh_pcloud
      ansible.builtin.include_role:
        name: jh_cloud

    - name: Add jh_display
      ansible.builtin.include_role:
        name: jh_display
      when: display_localhost_port is defined

    - name: Set default tty
      when: jehon_tty | length > 0
      ansible.builtin.systemd:
        name: jehon-chvt@{{ jehon_tty }}.service
        enable: true
        state: started

- name: Setup networking
  ansible.builtin.include_role:
    name: jh_network

- name: In full machine
  when: not virtual
  block:
    - name: Set a hostname to {{ inventory_hostname }}
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"
      when: inventory_hostname is match("[a-zA-Z][a-zA-Z0-9_-]+") and inventory_hostname != "localhost"

    - name: Firewall - allow ssh
      community.general.ufw:
        rule: allow
        name: ssh

    - name: Firewall - enable
      community.general.ufw:
        state: enabled

    - name: Add IP address to /etc/hosts
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/lineinfile_module.html
      ansible.builtin.lineinfile:
        dest: /etc/hosts
        # Match: <ip|ipv6> <host>.honlet <legacy> # ansible
        # TODO: remove <legacy> from match (when all hosts are adapted)
        regexp: '.* {{ item }}.honlet .* # ansible'
        # TODO: remove hostnames alias without .honlet
        line: "{{ jehon.ip[item] }} {{ item }}.honlet {{ item }} # ansible"
        state: present
      when: jehon.ip[item] is defined
      with_items: "{{ jehon.ip.keys() }}"
      # On docker, the /etc/hosts is not writable
