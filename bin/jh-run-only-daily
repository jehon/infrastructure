#!/usr/bin/env bash

set -o errexit
set -o pipefail
shopt -s nullglob

# shellcheck source-path=SCRIPTDIR/
. "$(dirname "$(realpath "${BASH_SOURCE[0]}")")/lib.sh"

command="${1:?Need at least the command as [1] - args may follow]}"

stateFilesRadix="${prjRoot}/tmp/history/$(jh-fs "path-to-file" "${command}")"

mkdir -p "$(dirname "${stateFilesRadix}")"

historyFile="${stateFilesRadix}.history"
lockFile="${stateFilesRadix}.lock"

if ! jh_exclusive "${lockFile}"; then
    echo "Already running at ${lockFile}"
    exit 0
fi

# Modified days ago
if find "${historyFile}" -mtime -1 -print >&/dev/null; then
    echo "No need to run it"
    exit 0
fi

echo "Need to run..."
# "$@"

touch "${historyFile}"
