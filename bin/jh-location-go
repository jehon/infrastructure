#!/usr/bin/env bash

set -o errexit

# shellcheck source-path=SCRIPTDIR/
. "$(dirname "$(realpath "${BASH_SOURCE[0]}")")/lib.sh"

# CONF="/etc/jehon/locations"
CONF="${JH_PKG_FOLDER}/conf/locations"

run_folder() {
    LOCATION="$1"
    FOLDER="$CONF/$LOCATION"
    header_begin "Location $LOCATION"

    if jh-fs is-empty "$FOLDER"; then
        jh_fatal "Folder is empty/not found: $FOLDER"
    fi

    for F in "$FOLDER"/* ; do
        FN="$( basename "$F" )"
        header_begin "$LOCATION - $FN: Running"
        if ! "$F" ; then
            jh_error "$FN"
        fi
        header_end
    done
    header_end
}

CACHE="/var/cache/jehon/location"
if [ -r "${CACHE}" ]; then
    PREV_LOCATION="$( cat "${CACHE}" )"
fi
LOCATION="${1:-$( jh-location-detect )}"

jh_debug "PREV_LOCATION: ${PREV_LOCATION}"
jh_info "Using location" "${LOCATION}"


run_folder "$LOCATION"
run_folder "always"
